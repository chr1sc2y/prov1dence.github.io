<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>CMake 入门 | 尾張</title>
<meta name=keywords content>
<meta name=description content="CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。
1. 构建单个文件 1.1 使用 GCC 编译 假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：
// safe_add.cpp #include <iostream>#include <memory>#define INT_MAX 2147483647 #define ERROR_DATA_OVERFLOW 2  int SafeIntAdd(std::unique_ptr<int> &sum, int a, int b) { if (a > INT_MAX - b) { *sum = INT_MAX; return ERROR_DATA_OVERFLOW; } *sum = a + b; return EXIT_SUCCESS; } int main() { int a, b; std::cin >> a >> b; std::unique_ptr<int> sum(new int(1)); int res = SafeIntAdd(sum, a, b); std::cout << *sum << std::endl; return res; } 我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：">
<meta name=author content>
<link rel=canonical href=http://zintrulcre.github.io/posts/c++/compilation/cmake/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-132809676-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="CMake 入门">
<meta property="og:description" content="CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。
1. 构建单个文件 1.1 使用 GCC 编译 假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：
// safe_add.cpp #include <iostream>#include <memory>#define INT_MAX 2147483647 #define ERROR_DATA_OVERFLOW 2  int SafeIntAdd(std::unique_ptr<int> &sum, int a, int b) { if (a > INT_MAX - b) { *sum = INT_MAX; return ERROR_DATA_OVERFLOW; } *sum = a + b; return EXIT_SUCCESS; } int main() { int a, b; std::cin >> a >> b; std::unique_ptr<int> sum(new int(1)); int res = SafeIntAdd(sum, a, b); std::cout << *sum << std::endl; return res; } 我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：">
<meta property="og:type" content="article">
<meta property="og:url" content="http://zintrulcre.github.io/posts/c++/compilation/cmake/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-21T15:46:06+08:00">
<meta property="article:modified_time" content="2020-06-21T15:46:06+08:00"><meta property="og:site_name" content="尾張">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="CMake 入门">
<meta name=twitter:description content="CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。
1. 构建单个文件 1.1 使用 GCC 编译 假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：
// safe_add.cpp #include <iostream>#include <memory>#define INT_MAX 2147483647 #define ERROR_DATA_OVERFLOW 2  int SafeIntAdd(std::unique_ptr<int> &sum, int a, int b) { if (a > INT_MAX - b) { *sum = INT_MAX; return ERROR_DATA_OVERFLOW; } *sum = a + b; return EXIT_SUCCESS; } int main() { int a, b; std::cin >> a >> b; std::unique_ptr<int> sum(new int(1)); int res = SafeIntAdd(sum, a, b); std::cout << *sum << std::endl; return res; } 我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://zintrulcre.github.io/posts/"},{"@type":"ListItem","position":2,"name":"CMake 入门","item":"http://zintrulcre.github.io/posts/c++/compilation/cmake/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CMake 入门","name":"CMake 入门","description":"CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。\n1. 构建单个文件 1.1 使用 GCC 编译 假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：\n// safe_add.cpp #include \u0026lt;iostream\u0026gt;#include \u0026lt;memory\u0026gt;#define INT_MAX 2147483647 #define ERROR_DATA_OVERFLOW 2  int SafeIntAdd(std::unique_ptr\u0026lt;int\u0026gt; \u0026amp;sum, int a, int b) { if (a \u0026gt; INT_MAX - b) { *sum = INT_MAX; return ERROR_DATA_OVERFLOW; } *sum = a + b; return EXIT_SUCCESS; } int main() { int a, b; std::cin \u0026gt;\u0026gt; a \u0026gt;\u0026gt; b; std::unique_ptr\u0026lt;int\u0026gt; sum(new int(1)); int res = SafeIntAdd(sum, a, b); std::cout \u0026lt;\u0026lt; *sum \u0026lt;\u0026lt; std::endl; return res; } 我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：","keywords":[],"articleBody":"CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。\n1. 构建单个文件 1.1 使用 GCC 编译 假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：\n// safe_add.cpp #include #include #define INT_MAX 2147483647 #define ERROR_DATA_OVERFLOW 2  int SafeIntAdd(std::unique_ptrint \u0026sum, int a, int b) { if (a  INT_MAX - b) { *sum = INT_MAX; return ERROR_DATA_OVERFLOW; } *sum = a + b; return EXIT_SUCCESS; } int main() { int a, b; std::cin  a  b; std::unique_ptrint sum(new int(1)); int res = SafeIntAdd(sum, a, b); std::cout  *sum  std::endl; return res; } 我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：\n[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o SafeIntAdd [joelzychen@DevCloud ~/cmake-tutorial]$ ./SafeIntAdd 2100000000 2100000000 2147483647 1.2 使用 cmake 构建 如果要使用 cmake 来生成 makefile 的话我们需要首先新建一个 CMakeLists.txt 文件，cmake 的所有配置都在这个文件中完成，CMakeLists.txt 中的内容大致如下：\ncmake_minimum_required(VERSION 3.10)project(SafeIntAdd)set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)message(STATUS \"CMAKE_CXX_FLAGS: \" \"${CMAKE_CXX_FLAGS}\")string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")message(STATUS \"CMAKE_CXX_FLAGS: \" \"${CMAKE_CXX_FLAGS}\")add_executable(SafeIntAdd main.cc)其中有一些基础的 cmake 指令，它们的含义如下：\n cmake_minimum_required：cmake 的最低版本要求 project：指定项目的名称 set：设置普通变量，缓存变量或环境变量，上面例子中的 add_executable：使用列出的源文件构建可执行文件  有几个需要注意的点：\n  cmake 的指令是不区分大小写的，写作 CMAKE_MINIMUM_REQUIRED 或 cmake_minimum_required，甚至是 cmAkE_mInImUm_rEquIrEd（不建议）都是可以的\n  在使用 set 指令指定 CMAKE_CXX_FLAGS 的时候通过空格来分隔多个编译选项，生成的 CMAKE_CXX_FLAGS 字符串是 “-g;-Wall”，需要用字符串替换将分号替换为空格\n  message 可以在构建的过程中向 stdout 输出一些信息，上面例子中的输出信息为：\n-- CMAKE_CXX_FLAGS: -g;-Wall -- CMAKE_CXX_FLAGS: -g -Wall   类似于 bash 脚本，在 CMakeLists.txt 中输出变量时要使用 “${CMAKE_CXX_FLAGS}” 的形式，而不能直接使用 CMAKE_CXX_FLAGS\n  编辑好 CMakeLists.txt 之后，我们可以新建一个 build 目录，并在 build 目录下使用 cmake 来进行构建，构建成功的话再使用 make 来进行编译和链接，最终得到 SafeAdd 这个可执行文件：\n[joelzychen@DevCloud ~/cmake-tutorial]$ mkdir build/ [joelzychen@DevCloud ~/cmake-tutorial]$ cd build/ [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake .. -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- CMAKE_CXX_FLAGS: -g;-Wall -- CMAKE_CXX_FLAGS: -g -Wall -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target SafeIntAdd [ 50%] Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o [100%] Linking CXX executable SafeIntAdd [100%] Built target SafeIntAdd [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./SafeIntAdd 2100000000 2100000000 2147483647 2. 构建多个文件 2.1 使用 GCC 编译 假设现在我们希望将加法函数放到单独的文件中去，并在 main 函数所在的源文件中包含这个文件：\n// main.cc #include \"math.h\"#include \"error_code.h\"#include  int main() { int a{ 0 }, b{ 0 }, c{ 0 }; std::cin  a  b  c; int sum{ 0 }; int ret_val = SafeAdd(sum, a, b, c); std::cout  sum  std::endl; return ret_val; } // util/math.h #ifndef UTIL_MATH_H #define UTIL_MATH_H  #include \"error_code.h\"#include  templatetypename ValueType ValueType ValueTypeMax(ValueType) { return std::numeric_limitsValueType::max(); } templatetypename ValueType int SafeAdd(ValueType \u0026sum) { return exit_success; } templatetypename ValueType, typename ...ValueTypes int SafeAdd(ValueType \u0026sum, const ValueType \u0026value, const ValueTypes \u0026...other_values) { int ret_val = SafeAddValueType(sum, other_values...); if (ret_val != exit_success) { return ret_val; } if (sum  ValueTypeMax(value) - value) { sum = ValueTypeMax(value); return error_data_overflow; } sum += value; return exit_success; } #endif // definition/error_code.h #ifndef DEFINITION_ERROR_CODE_H #define DEFINITION_ERROR_CODE_H  constexpr int exit_success = 0; constexpr int exit_failure = 1; constexpr int error_data_overflow = 2; #endif 我们可以在使用 GCC 编译的时候使用 -I 参数指定头文件所在的目录：\n[joelzychen@DevCloud ~/safe_add]$ g++ -g -Wall -std=c++11 -Ilib -Idefinition -o SafeAdd main.cc [joelzychen@DevCloud ~/safe_add]$ ./SafeAdd 20000 50000 80000 150000 2.2 使用 cmake 构建 cmake_minimum_required(VERSION 3.10)project(SafeIntAdd)set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")include_directories(lib/ definition/)aux_source_directory(./ SOURCE_DIR)add_executable(SafeIntAdd ${SOURCE_DIR})相比于构建单个文件，我们额外使用了两个指令：\n include_directories：添加多个头文件搜索路径，路径之间用空格分隔；如果将 lib 和 definition 目录都添加到到搜索路径的话，在 include 的时候就不需要使用相对路径了 aux_source_directory：在目录中查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中；需要注意这个指令不会递归包含子目录  接下来进入 build 目录进行构建：\n[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf * [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake .. -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target SafeIntAdd [ 50%] Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o [100%] Linking CXX executable SafeIntAdd [100%] Built target SafeIntAdd [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./SafeIntAdd 2000000000 1900000000 2147483647 3. 构建依赖于静态库的项目 关于静态库和动态库相关内容可以参考浅谈静态库和动态库。\n3.1 使用 GCC 编译静态库文件 假设现在我们希望将 exp2 函数封装到一个计算器单例类中，并计算 2 的 n 次方，并为此编写了以下这些文件：\n// main.cc #include \"util/calculator.h\"#include \"definition/error_code.h\"#include  int main() { double a{ 0 }; std::cin  a; double exp2{ 0 }; int ret_val = Calculator::GetInstance().Exp2(exp2, a); if (ret_val != exit_success) { return ret_val; } std::cout  exp2  std::endl; return exit_success; } // util/singleton.h #ifndef UTIL_SINGLETON_H #define UTIL_SINGLETON_H  template typename T class Singleton { public: static T\u0026 GetInstance() { static T instance; return instance; } Singleton(Singleton const \u0026) = delete; Singleton\u0026 operator=(Singleton const \u0026) = delete; protected: Singleton() = default; ~Singleton() = default; }; #endif // definition/error_code.h #ifndef DEFINITION_ERROR_CODE_H #define DEFINITION_ERROR_CODE_H  constexpr int exit_success = 0; constexpr int exit_failure = 1; constexpr int error_data_overflow = 2; #endif // util/calculator.h #ifndef UTIL_CALCULATOR_H #define UTIL_CALCULATOR_H  #include \"singleton.h\"#include \"../definition/error_code.h\"#include #include  class Calculator : public SingletonCalculator { public: templatetypename ValueType ValueType ValueTypeMax(ValueType) { return std::numeric_limitsValueType::max(); } int Exp2(double \u0026exp2, const double \u0026val); }; #endif 为了方便生成静态库文件，我们先将 calculator.cc 这个文件放到 archive 目录下：\n// archive/calculator.cc #include \"../util/calculator.h\" int Calculator::Exp2(double \u0026exp2, const double \u0026val) { if (std::sqrt(ValueTypeMax(val))  val) { exp2 = ValueTypeMax(val); return error_data_overflow; } exp2 = std::exp2(val); return exit_success; } 对于 calculator.cc 这个源文件，我们可以使用 -c 参数将其编译为 obj 文件，再使用 ar 归档就能将其编译为一个 .a 库文件了：：\n[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -c [joelzychen@DevCloud ~/cmake-tutorial/archive]$ ar -crv libcalculator.a calculator.o a - calculator.o 3.2 使用 GCC 编译项目和链接静态库 现在的目录结构如下：\n[joelzychen@DevCloud ~/cmake-tutorial]$ tree . |-- archive | |-- calculator.cc | |-- calculator.o | `-- libcalculator.a |-- CMakeLists.txt |-- definition | `-- error_code.h |-- main.cc `-- util |-- calculator.h `-- singleton.h 3 directories, 8 files 使用 GCC 编译和链接到对应的静态库文件即可得到可执行文件：\n[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o Exp2 -Larchive -lcalculator [joelzychen@DevCloud ~/cmake-tutorial]$ ll Exp2 32K -rwxrwxr-x 1 joelzychen joelzychen 31K Jun 21 14:38 Exp2 [joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2 8 256 需要注意的点有：\n -Llib 用于指定库文件目录 -lsingleton 用于指定库文件 -L 和 -l 参数一定要在 -o 参数之后  3.3 使用 cmake 构建项目和链接静态库 我们刚才已经用 GCC 编译好了静态库文件，所以可以直接在 CMakeLists.txt 里添加链接静态库的指令：\ncmake_minimum_required(VERSION 3.10)project(Exp2)set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)message(STATUS \"source dir: \" ${PROJECT_SOURCE_DIR})message(STATUS \"binary dir: \" ${PROJECT_BINARY_DIR})message(STATUS \"output dir: \" ${CMAKE_RUNTIME_OUTPUT_DIRECTORY})include_directories(./)aux_source_directory(./ SOURCE_DIR)link_directories(archive/)add_executable(Exp2 ${SOURCE_DIR})target_link_libraries(Exp2 libcalculator.a)# target_link_libraries(Exp2 calculator) 和之前相比，额外使用的指令有：\n link_directories：指定静态库或动态库的搜索路径 target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价  然后进入 build 目录进行构建：\n[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf * [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../ -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- source dir: /home/joelzychen/cmake-tutorial -- binary dir: /home/joelzychen/cmake-tutorial/build -- output dir: /home/joelzychen/cmake-tutorial/build/bin/ -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target Exp2 [ 50%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o [100%] Linking CXX executable bin/Exp2 [100%] Built target Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 32K -rwxrwxr-x 1 joelzychen joelzychen 31K Jun 21 14:58 bin/Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 6 64 可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接得到的二进制文件大小是相同的。这次用 set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/) 命令将生成的二进制文件放到了 bin 目录下，注意这里的 bin 目录是使用 cmake 进行构建的目录（PROJECT_BINARY_DIR），不是 CMakeLists.txt 所在的目录（PROJECT_SOURCE_DIR）。\n3.4 使用 cmake 构建静态库文件和项目 除了直接引用外部的静态库，cmake 还可以先将源文件编译成静态库之后在进行构建：\ncmake_minimum_required(VERSION 3.10)set(project_name Exp2)project(${project_name})set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)message(STATUS \"source dir: \" ${PROJECT_SOURCE_DIR})message(STATUS \"binary dir: \" ${PROJECT_BINARY_DIR})message(STATUS \"output dir: \" \"${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}\")include_directories(./)aux_source_directory(./ SOURCE_DIR)set(static_lib_source_file archive/calculator.cc)add_library(calculator_static STATIC ${static_lib_source_file})add_executable(${project_name} ${SOURCE_DIR})target_link_libraries(${project_name} calculator_static)这里用到了一个新的指令 add_library 来使用指定的源文件生成库文件，再使用 target_link_libraries 将生成的库文件添加到项目中；接下来进行构建：\n[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf * [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../ -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- source dir: /home/joelzychen/cmake-tutorial -- binary dir: /home/joelzychen/cmake-tutorial/build -- output dir: /home/joelzychen/cmake-tutorial/build/bin/ -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target calculator_static [ 25%] Building CXX object CMakeFiles/calculator_static.dir/archive/calculator.cc.o [ 50%] Linking CXX static library libcalculator_static.a [ 50%] Built target calculator_static Scanning dependencies of target Exp2 [ 75%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o [100%] Linking CXX executable bin/Exp2 [100%] Built target Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ll | grep calculator 12K -rw-rw-r-- 1 joelzychen joelzychen 11K Jun 21 15:30 libcalculator_static.a [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 5 32 可以看到在 build 目录下生成了一个名为 libcalculator_static.a 的静态库文件，这个名字是由使用 add_library 指令时的第一个参数指定的。\n4. 构建依赖于动态库的项目 4.1 使用 GCC 编译动态库文件 仍然使用之前已有的文件，在 archive 目录下生成动态库文件：\n[joelzychen@DevCloud ~/cmake-tutorial/archive]$ rm calculator.o libcalculator.a [joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -c -fPIC [joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.o -g -Wall -std=c++11 -shared -o libcalculator.so 分为两个步骤：\n 使用 -c 和 -fPIC 参数生成位置无关的（position independent code）机器码 .o 文件 使用 -shared 参数生成 .so 动态库文件  也可以合并为一个步骤：\n[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -shared -fPIC -o libcalculator.so 这样可以直接生成动态库文件，省去生成机器码文件的中间步骤。\n4.2 使用 GCC 编译项目和链接动态库 和链接到静态库类似，在编译后链接动态库即可生成二进制文件：\n[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o Exp2 -Larchive -lcalculator [joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2 ./Exp2: error while loading shared libraries: libcalculator.so: cannot open shared object file: No such file or directory 我们发现在运行二级制文件时会出现找不到动态库的报错，这是因为动态链接库环境变量的目录下没有找到编译时所用到的动态库，我们可以将对应的目录添加到环境变量下，或是将动态库拷贝到环境变量的目录下：\n[joelzychen@DevCloud ~/cmake-tutorial]$ echo $LD_LIBRARY_PATH [joelzychen@DevCloud ~/cmake-tutorial]$ export LD_LIBRARY_PATH=\"/usr/lib/\" [joelzychen@DevCloud ~/cmake-tutorial]$ sudo cp archive/libcalculator.so /usr/lib/ 接下来就可以运行可执行文件了，可以看到使用链接动态库方式生成的可执行文件的大小要小于使用链接静态库方式生成的可执行文件，使用 ldd 命令也能看到可执行文件是正确地调用了对应的动态库文件：\n[joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2 9 512 [joelzychen@DevCloud ~/cmake-tutorial]$ ll Exp2 28K -rwxrwxr-x 1 joelzychen joelzychen 28K Jun 21 14:25 Exp2 [joelzychen@DevCloud ~/cmake-tutorial]$ ldd Exp2 | grep calculator libcalculator.so = /usr/lib/libcalculator.so (0x00007fd2391f0000) 4.3 使用 cmake 构建项目和链接动态库 和构建静态库类似，只需要将 CMakeLists.txt 中链接静态库的指令修改为链接动态库即可进行构建：\ncmake_minimum_required(VERSION 3.10)project(Exp2)set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)message(STATUS \"source dir: \" ${PROJECT_SOURCE_DIR})message(STATUS \"binary dir: \" ${PROJECT_BINARY_DIR})message(STATUS \"output dir: \" \"${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}\")include_directories(./)aux_source_directory(./ SOURCE_DIR)link_directories(archive/)add_executable(Exp2 ${SOURCE_DIR})target_link_libraries(Exp2 libcalculator.so)[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf * [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../ -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- source dir: /home/joelzychen/cmake-tutorial -- binary dir: /home/joelzychen/cmake-tutorial/build -- output dir: /home/joelzychen/cmake-tutorial/build/bin/ -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target Exp2 [ 50%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o [100%] Linking CXX executable bin/Exp2 [100%] Built target Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 28K -rwxrwxr-x 1 joelzychen joelzychen 28K Jun 21 15:04 bin/Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ldd bin/Exp2 | grep calculator libcalculator.so = /home/joelzychen/cmake-tutorial/archive/libcalculator.so (0x00007f4c87e35000) [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 6 64 可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接动态库得到的二进制文件大小也是相同的。\n4.4 使用 cmake 构建动态库文件和项目 使用 cmake 构建动态库的步骤和构建静态库的步骤几乎一模一样，只需要将 add_library 的 STATIC 参数改为 SHARED 即可：\ncmake_minimum_required(VERSION 3.10)set(project_name Exp2)project(${project_name})set(CMAKE_CXX_COMPILER \"c++\")set(CMAKE_CXX_STANDARD 11)set(CMAKE_CXX_STANDARD_REQUIRED True)set(CMAKE_CXX_FLAGS -g -Wall)string(REPLACE \";\" \" \" CMAKE_CXX_FLAGS \"${CMAKE_CXX_FLAGS}\")set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)message(STATUS \"source dir: \" ${PROJECT_SOURCE_DIR})message(STATUS \"binary dir: \" ${PROJECT_BINARY_DIR})message(STATUS \"output dir: \" \"${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}\")include_directories(./)aux_source_directory(./ SOURCE_DIR)set(shared_lib_source_file archive/calculator.cc)add_library(calculator_shared SHARED ${shared_lib_source_file})add_executable(${project_name} ${SOURCE_DIR})target_link_libraries(${project_name} calculator_shared)[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf * [joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake .. -- The C compiler identification is GNU 4.8.5 -- The CXX compiler identification is GNU 4.8.5 -- Check for working C compiler: /usr/bin/cc -- Check for working C compiler: /usr/bin/cc - works -- Detecting C compiler ABI info -- Detecting C compiler ABI info - done -- Detecting C compile features -- Detecting C compile features - done -- Check for working CXX compiler: /usr/bin/c++ -- Check for working CXX compiler: /usr/bin/c++ - works -- Detecting CXX compiler ABI info -- Detecting CXX compiler ABI info - done -- Detecting CXX compile features -- Detecting CXX compile features - done -- source dir: /home/joelzychen/cmake-tutorial -- binary dir: /home/joelzychen/cmake-tutorial/build -- output dir: /home/joelzychen/cmake-tutorial/build/bin/ -- Configuring done -- Generating done -- Build files have been written to: /home/joelzychen/cmake-tutorial/build [joelzychen@DevCloud ~/cmake-tutorial/build]$ make Scanning dependencies of target calculator_shared [ 25%] Building CXX object CMakeFiles/calculator_shared.dir/archive/calculator.cc.o [ 50%] Linking CXX shared library libcalculator_shared.so [ 50%] Built target calculator_shared Scanning dependencies of target Exp2 [ 75%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o [100%] Linking CXX executable bin/Exp2 [100%] Built target Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ll | grep calculator 16K -rwxrwxr-x 1 joelzychen joelzychen 13K Jun 21 15:34 libcalculator_shared.so [joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 28K -rwxrwxr-x 1 joelzychen joelzychen 28K Jun 21 15:34 bin/Exp2 [joelzychen@DevCloud ~/cmake-tutorial/build]$ ldd bin/Exp2 | grep calculator libcalculator_shared.so = /home/joelzychen/cmake-tutorial/build/libcalculator_shared.so (0x00007f1fa5aa5000) [joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 7 128 可以看到得到的二进制文件的相关信息和使用前几种方法得到的都是相同的。\n5. 常用命令 5.1 项目相关  cmake_minimum_required(VERSION 3.10)：指定 cmake 的最低版本要求 project(project_name)：指定项目的名称 set(CMAKE_CXX_FLAGS -g -Wall -pthread)：设置普通变量，缓存变量或环境变量  5.2 编译相关  include_directories：指定头文件的目录，类似于 GCC 编译时的 -I 参数；等价于将头文件目录添加到环境变量 CPLUS_INCLUDE_PATH 中 aux_source_directory：在目录中（不含子目录）查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中 add_executable：使用列出的源文件构建可执行文件 add_definitions：宏定义  5.3 链接相关  link_directories：指定库文件的目录，类似于 GCC 链接时的 -L 参数；等价于将库文件目录添加到环境变量 LD_LIBRARY_PATH 中 target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价  6. 总结 本文通过几个示例程序对比了在 Linux 下使用 GCC 和 cmake 来编译和构建程序的基本步骤，了解了一些 cmake 的基础指令。实际开发中的项目往往会非常大，以致于不能够直接使用 GCC 来编译整个项目，在这种场景下使用 cmake 进行构建往往能够节省时间和提高效率，让我们能够专注在项目的开发上。在实际应用中编写 CMakeLists.txt 的时候还会遇到非常多的问题、不熟悉的指令和其他的使用技巧，这些都需要结合教程和实践来进一步学习。\n","wordCount":"2202","inLanguage":"en","datePublished":"2020-06-21T15:46:06+08:00","dateModified":"2020-06-21T15:46:06+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://zintrulcre.github.io/posts/c++/compilation/cmake/"},"publisher":{"@type":"Organization","name":"尾張","logo":{"@type":"ImageObject","url":"http://zintrulcre.github.io/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=http://zintrulcre.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=http://zintrulcre.github.io/archives/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=http://zintrulcre.github.io/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=http://zintrulcre.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://zintrulcre.github.io/posts/>Posts</a></div>
<h1 class=post-title>
CMake 入门
</h1>
<div class=post-meta><span title="2020-06-21 15:46:06 +0800 CST">June 21, 2020</span>&nbsp;·&nbsp;11 min
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#cmake-%e5%85%a5%e9%97%a8 aria-label="CMake 入门">CMake 入门</a><ul>
<li>
<a href=#0-%e5%ba%8f aria-label="0. 序">0. 序</a></li>
<li>
<a href=#1-%e6%9e%84%e5%bb%ba%e5%8d%95%e4%b8%aa%e6%96%87%e4%bb%b6 aria-label="1. 构建单个文件">1. 构建单个文件</a><ul>
<li>
<a href=#11-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91 aria-label="1.1 使用 GCC 编译">1.1 使用 GCC 编译</a></li>
<li>
<a href=#12-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba aria-label="1.2 使用 cmake 构建">1.2 使用 cmake 构建</a></li></ul>
</li>
<li>
<a href=#2-%e6%9e%84%e5%bb%ba%e5%a4%9a%e4%b8%aa%e6%96%87%e4%bb%b6 aria-label="2. 构建多个文件">2. 构建多个文件</a><ul>
<li>
<a href=#21-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91 aria-label="2.1 使用 GCC 编译">2.1 使用 GCC 编译</a></li>
<li>
<a href=#22-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba aria-label="2.2 使用 cmake 构建">2.2 使用 cmake 构建</a></li></ul>
</li>
<li>
<a href=#3-%e6%9e%84%e5%bb%ba%e4%be%9d%e8%b5%96%e4%ba%8e%e9%9d%99%e6%80%81%e5%ba%93%e7%9a%84%e9%a1%b9%e7%9b%ae aria-label="3. 构建依赖于静态库的项目">3. 构建依赖于静态库的项目</a><ul>
<li>
<a href=#31-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91%e9%9d%99%e6%80%81%e5%ba%93%e6%96%87%e4%bb%b6 aria-label="3.1 使用 GCC 编译静态库文件">3.1 使用 GCC 编译静态库文件</a></li>
<li>
<a href=#32-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91%e9%a1%b9%e7%9b%ae%e5%92%8c%e9%93%be%e6%8e%a5%e9%9d%99%e6%80%81%e5%ba%93 aria-label="3.2 使用 GCC 编译项目和链接静态库">3.2 使用 GCC 编译项目和链接静态库</a></li>
<li>
<a href=#33-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae%e5%92%8c%e9%93%be%e6%8e%a5%e9%9d%99%e6%80%81%e5%ba%93 aria-label="3.3 使用 cmake 构建项目和链接静态库">3.3 使用 cmake 构建项目和链接静态库</a></li>
<li>
<a href=#34-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba%e9%9d%99%e6%80%81%e5%ba%93%e6%96%87%e4%bb%b6%e5%92%8c%e9%a1%b9%e7%9b%ae aria-label="3.4 使用 cmake 构建静态库文件和项目">3.4 使用 cmake 构建静态库文件和项目</a></li></ul>
</li>
<li>
<a href=#4-%e6%9e%84%e5%bb%ba%e4%be%9d%e8%b5%96%e4%ba%8e%e5%8a%a8%e6%80%81%e5%ba%93%e7%9a%84%e9%a1%b9%e7%9b%ae aria-label="4. 构建依赖于动态库的项目">4. 构建依赖于动态库的项目</a><ul>
<li>
<a href=#41-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91%e5%8a%a8%e6%80%81%e5%ba%93%e6%96%87%e4%bb%b6 aria-label="4.1 使用 GCC 编译动态库文件">4.1 使用 GCC 编译动态库文件</a></li>
<li>
<a href=#42-%e4%bd%bf%e7%94%a8-gcc-%e7%bc%96%e8%af%91%e9%a1%b9%e7%9b%ae%e5%92%8c%e9%93%be%e6%8e%a5%e5%8a%a8%e6%80%81%e5%ba%93 aria-label="4.2 使用 GCC 编译项目和链接动态库">4.2 使用 GCC 编译项目和链接动态库</a></li>
<li>
<a href=#43-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae%e5%92%8c%e9%93%be%e6%8e%a5%e5%8a%a8%e6%80%81%e5%ba%93 aria-label="4.3 使用 cmake 构建项目和链接动态库">4.3 使用 cmake 构建项目和链接动态库</a></li>
<li>
<a href=#44-%e4%bd%bf%e7%94%a8-cmake-%e6%9e%84%e5%bb%ba%e5%8a%a8%e6%80%81%e5%ba%93%e6%96%87%e4%bb%b6%e5%92%8c%e9%a1%b9%e7%9b%ae aria-label="4.4 使用 cmake 构建动态库文件和项目">4.4 使用 cmake 构建动态库文件和项目</a></li></ul>
</li>
<li>
<a href=#5-%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label="5. 常用命令">5. 常用命令</a><ul>
<li>
<a href=#51-%e9%a1%b9%e7%9b%ae%e7%9b%b8%e5%85%b3 aria-label="5.1 项目相关">5.1 项目相关</a></li>
<li>
<a href=#52-%e7%bc%96%e8%af%91%e7%9b%b8%e5%85%b3 aria-label="5.2 编译相关">5.2 编译相关</a></li>
<li>
<a href=#53-%e9%93%be%e6%8e%a5%e7%9b%b8%e5%85%b3 aria-label="5.3 链接相关">5.3 链接相关</a></li></ul>
</li>
<li>
<a href=#6-%e6%80%bb%e7%bb%93 aria-label="6. 总结">6. 总结</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=cmake-入门>CMake 入门<a hidden class=anchor aria-hidden=true href=#cmake-入门>#</a></h1>
<h2 id=0-序>0. 序<a hidden class=anchor aria-hidden=true href=#0-序>#</a></h2>
<p>CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。</p>
<h2 id=1-构建单个文件>1. 构建单个文件<a hidden class=anchor aria-hidden=true href=#1-构建单个文件>#</a></h2>
<h3 id=11-使用-gcc-编译>1.1 使用 GCC 编译<a hidden class=anchor aria-hidden=true href=#11-使用-gcc-编译>#</a></h3>
<p>假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// safe_add.cpp
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;memory&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#define INT_MAX 2147483647
</span><span style=color:#75715e>#define ERROR_DATA_OVERFLOW 2
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>SafeIntAdd</span>(std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>&amp;</span>sum, <span style=color:#66d9ef>int</span> a, <span style=color:#66d9ef>int</span> b)
{
    <span style=color:#66d9ef>if</span> (a <span style=color:#f92672>&gt;</span> INT_MAX <span style=color:#f92672>-</span> b)
    {
        <span style=color:#f92672>*</span>sum <span style=color:#f92672>=</span> INT_MAX;
        <span style=color:#66d9ef>return</span> ERROR_DATA_OVERFLOW;
    }
    <span style=color:#f92672>*</span>sum <span style=color:#f92672>=</span> a <span style=color:#f92672>+</span> b;
    <span style=color:#66d9ef>return</span> EXIT_SUCCESS;
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
{
    <span style=color:#66d9ef>int</span> a, b;
    std<span style=color:#f92672>::</span>cin <span style=color:#f92672>&gt;&gt;</span> a <span style=color:#f92672>&gt;&gt;</span> b;
    std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span> sum(<span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span>(<span style=color:#ae81ff>1</span>));
    <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> SafeIntAdd(sum, a, b);
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#f92672>*</span>sum <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
    <span style=color:#66d9ef>return</span> res;
}

</code></pre></div><p>我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ g++ main.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -o SafeIntAdd
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ./SafeIntAdd 
<span style=color:#ae81ff>2100000000</span> <span style=color:#ae81ff>2100000000</span>
<span style=color:#ae81ff>2147483647</span>
</code></pre></div><h3 id=12-使用-cmake-构建>1.2 使用 cmake 构建<a hidden class=anchor aria-hidden=true href=#12-使用-cmake-构建>#</a></h3>
<p>如果要使用 cmake 来生成 makefile 的话我们需要首先新建一个 CMakeLists.txt 文件，cmake 的所有配置都在这个文件中完成，CMakeLists.txt 中的内容大致如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#e6db74>SafeIntAdd</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;CMAKE_CXX_FLAGS: &#34;</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;CMAKE_CXX_FLAGS: &#34;</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#e6db74>SafeIntAdd</span> <span style=color:#e6db74>main.cc</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>其中有一些基础的 cmake 指令，它们的含义如下：</p>
<ol>
<li>cmake_minimum_required：cmake 的最低版本要求</li>
<li>project：指定项目的名称</li>
<li>set：设置普通变量，缓存变量或环境变量，上面例子中的</li>
<li>add_executable：使用列出的源文件构建可执行文件</li>
</ol>
<p>有几个需要注意的点：</p>
<ol>
<li>
<p>cmake 的指令是不区分大小写的，写作 CMAKE_MINIMUM_REQUIRED 或 cmake_minimum_required，甚至是 cmAkE_mInImUm_rEquIrEd（不建议）都是可以的</p>
</li>
<li>
<p>在使用 set 指令指定 CMAKE_CXX_FLAGS 的时候通过空格来分隔多个编译选项，生成的 CMAKE_CXX_FLAGS 字符串是 &ldquo;-g;-Wall&rdquo;，需要用字符串替换将分号替换为空格</p>
</li>
<li>
<p>message 可以在构建的过程中向 stdout 输出一些信息，上面例子中的输出信息为：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-- CMAKE_CXX_FLAGS: -g;-Wall
-- CMAKE_CXX_FLAGS: -g -Wall
</code></pre></div></li>
<li>
<p>类似于 bash 脚本，在 CMakeLists.txt 中输出变量时要使用 &ldquo;${CMAKE_CXX_FLAGS}&rdquo; 的形式，而不能直接使用 CMAKE_CXX_FLAGS</p>
</li>
</ol>
<p>编辑好 CMakeLists.txt 之后，我们可以新建一个 build 目录，并在 build 目录下使用 cmake 来进行构建，构建成功的话再使用 make 来进行编译和链接，最终得到 SafeAdd 这个可执行文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ mkdir build/
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ cd build/
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- CMAKE_CXX_FLAGS: -g;-Wall
-- CMAKE_CXX_FLAGS: -g -Wall
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target SafeIntAdd
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable SafeIntAdd
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target SafeIntAdd
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./SafeIntAdd 
<span style=color:#ae81ff>2100000000</span> <span style=color:#ae81ff>2100000000</span>
<span style=color:#ae81ff>2147483647</span>
</code></pre></div><h2 id=2-构建多个文件>2. 构建多个文件<a hidden class=anchor aria-hidden=true href=#2-构建多个文件>#</a></h2>
<h3 id=21-使用-gcc-编译>2.1 使用 GCC 编译<a hidden class=anchor aria-hidden=true href=#21-使用-gcc-编译>#</a></h3>
<p>假设现在我们希望将加法函数放到单独的文件中去，并在 main 函数所在的源文件中包含这个文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// main.cc
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;math.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;error_code.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
{
    <span style=color:#66d9ef>int</span> a{ <span style=color:#ae81ff>0</span> }, b{ <span style=color:#ae81ff>0</span> }, c{ <span style=color:#ae81ff>0</span> };
    std<span style=color:#f92672>::</span>cin <span style=color:#f92672>&gt;&gt;</span> a <span style=color:#f92672>&gt;&gt;</span> b <span style=color:#f92672>&gt;&gt;</span> c;
    <span style=color:#66d9ef>int</span> sum{ <span style=color:#ae81ff>0</span> };
    <span style=color:#66d9ef>int</span> ret_val <span style=color:#f92672>=</span> SafeAdd(sum, a, b, c);
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> sum <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
    <span style=color:#66d9ef>return</span> ret_val;
}

</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// util/math.h
</span><span style=color:#75715e></span><span style=color:#75715e>#ifndef UTIL_MATH_H
</span><span style=color:#75715e>#define UTIL_MATH_H
</span><span style=color:#75715e></span>
<span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;error_code.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;limits&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> ValueType<span style=color:#f92672>&gt;</span>
ValueType ValueTypeMax(ValueType)
{
    <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>numeric_limits<span style=color:#f92672>&lt;</span>ValueType<span style=color:#f92672>&gt;::</span>max();
}

<span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> ValueType<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>int</span> SafeAdd(ValueType <span style=color:#f92672>&amp;</span>sum)
{
    <span style=color:#66d9ef>return</span> exit_success;
}

<span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> ValueType, <span style=color:#66d9ef>typename</span> ...ValueTypes<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>int</span> SafeAdd(ValueType <span style=color:#f92672>&amp;</span>sum, <span style=color:#66d9ef>const</span> ValueType <span style=color:#f92672>&amp;</span>value, <span style=color:#66d9ef>const</span> ValueTypes <span style=color:#f92672>&amp;</span>...other_values)
{
    <span style=color:#66d9ef>int</span> ret_val <span style=color:#f92672>=</span> SafeAdd<span style=color:#f92672>&lt;</span>ValueType<span style=color:#f92672>&gt;</span>(sum, other_values...);
    <span style=color:#66d9ef>if</span> (ret_val <span style=color:#f92672>!=</span> exit_success)
    {
        <span style=color:#66d9ef>return</span> ret_val;
    }
    <span style=color:#66d9ef>if</span> (sum <span style=color:#f92672>&gt;</span> ValueTypeMax(value) <span style=color:#f92672>-</span> value)
    {
        sum <span style=color:#f92672>=</span> ValueTypeMax(value);
        <span style=color:#66d9ef>return</span> error_data_overflow;
    }
    sum <span style=color:#f92672>+=</span> value;
    <span style=color:#66d9ef>return</span> exit_success;
}

<span style=color:#75715e>#endif
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// definition/error_code.h
</span><span style=color:#75715e></span><span style=color:#75715e>#ifndef DEFINITION_ERROR_CODE_H
</span><span style=color:#75715e>#define DEFINITION_ERROR_CODE_H
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> exit_success <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> exit_failure <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> error_data_overflow <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#75715e>#endif
</span></code></pre></div><p>我们可以在使用 GCC 编译的时候使用 -I 参数指定头文件所在的目录：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/safe_add<span style=color:#f92672>]</span>$ g++ -g -Wall -std<span style=color:#f92672>=</span>c++11 -Ilib -Idefinition -o SafeAdd main.cc
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/safe_add<span style=color:#f92672>]</span>$ ./SafeAdd
<span style=color:#ae81ff>20000</span> <span style=color:#ae81ff>50000</span> <span style=color:#ae81ff>80000</span>
<span style=color:#ae81ff>150000</span>
</code></pre></div><h3 id=22-使用-cmake-构建>2.2 使用 cmake 构建<a hidden class=anchor aria-hidden=true href=#22-使用-cmake-构建>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#e6db74>SafeIntAdd</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>include_directories(<span style=color:#e6db74>lib/</span> <span style=color:#e6db74>definition/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>aux_source_directory(<span style=color:#e6db74>./</span> <span style=color:#e6db74>SOURCE_DIR</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#e6db74>SafeIntAdd</span> <span style=color:#f92672>${</span>SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>相比于构建单个文件，我们额外使用了两个指令：</p>
<ol>
<li>include_directories：添加多个头文件搜索路径，路径之间用空格分隔；如果将 lib 和 definition 目录都添加到到搜索路径的话，在 include 的时候就不需要使用相对路径了</li>
<li>aux_source_directory：在目录中查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中；需要注意这个指令不会递归包含子目录</li>
</ol>
<p>接下来进入 build 目录进行构建：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ rm -rf *
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target SafeIntAdd
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable SafeIntAdd
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target SafeIntAdd
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./SafeIntAdd 
<span style=color:#ae81ff>2000000000</span> <span style=color:#ae81ff>1900000000</span>
<span style=color:#ae81ff>2147483647</span>
</code></pre></div><h2 id=3-构建依赖于静态库的项目>3. 构建依赖于静态库的项目<a hidden class=anchor aria-hidden=true href=#3-构建依赖于静态库的项目>#</a></h2>
<p>关于静态库和动态库相关内容可以参考<a href=https://zhuanlan.zhihu.com/p/71372182>浅谈静态库和动态库</a>。</p>
<h3 id=31-使用-gcc-编译静态库文件>3.1 使用 GCC 编译静态库文件<a hidden class=anchor aria-hidden=true href=#31-使用-gcc-编译静态库文件>#</a></h3>
<p>假设现在我们希望将 exp2 函数封装到一个计算器单例类中，并计算 2 的 n 次方，并为此编写了以下这些文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// main.cc
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;util/calculator.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;definition/error_code.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
{
    <span style=color:#66d9ef>double</span> a{ <span style=color:#ae81ff>0</span> };
    std<span style=color:#f92672>::</span>cin <span style=color:#f92672>&gt;&gt;</span> a;
    <span style=color:#66d9ef>double</span> exp2{ <span style=color:#ae81ff>0</span> };
    <span style=color:#66d9ef>int</span> ret_val <span style=color:#f92672>=</span> Calculator<span style=color:#f92672>::</span>GetInstance().Exp2(exp2, a);
    <span style=color:#66d9ef>if</span> (ret_val <span style=color:#f92672>!=</span> exit_success)
    {
        <span style=color:#66d9ef>return</span> ret_val;
    }
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> exp2 <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
    <span style=color:#66d9ef>return</span> exit_success;
}

</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// util/singleton.h
</span><span style=color:#75715e></span><span style=color:#75715e>#ifndef UTIL_SINGLETON_H
</span><span style=color:#75715e>#define UTIL_SINGLETON_H
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Singleton</span>
{
<span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
    <span style=color:#66d9ef>static</span> T<span style=color:#f92672>&amp;</span> GetInstance()
    {
        <span style=color:#66d9ef>static</span> T instance;
        <span style=color:#66d9ef>return</span> instance;
    }
    Singleton(Singleton <span style=color:#66d9ef>const</span> <span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;
    Singleton<span style=color:#f92672>&amp;</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span>(Singleton <span style=color:#66d9ef>const</span> <span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;

<span style=color:#66d9ef>protected</span><span style=color:#f92672>:</span>
    Singleton() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
    <span style=color:#f92672>~</span>Singleton() <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;

};

<span style=color:#75715e>#endif
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>// definition/error_code.h
</span><span style=color:#75715e></span><span style=color:#75715e>#ifndef DEFINITION_ERROR_CODE_H
</span><span style=color:#75715e>#define DEFINITION_ERROR_CODE_H
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> exit_success <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> exit_failure <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>constexpr</span> <span style=color:#66d9ef>int</span> error_data_overflow <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#75715e>#endif
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// util/calculator.h
</span><span style=color:#75715e></span><span style=color:#75715e>#ifndef UTIL_CALCULATOR_H
</span><span style=color:#75715e>#define UTIL_CALCULATOR_H
</span><span style=color:#75715e></span>
<span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;singleton.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;../definition/error_code.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;limits&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cmath&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Calculator</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>public</span> Singleton<span style=color:#f92672>&lt;</span>Calculator<span style=color:#f92672>&gt;</span>
{
<span style=color:#66d9ef>public</span><span style=color:#f92672>:</span>
    <span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> ValueType<span style=color:#f92672>&gt;</span>
    ValueType ValueTypeMax(ValueType)
    {
        <span style=color:#66d9ef>return</span> std<span style=color:#f92672>::</span>numeric_limits<span style=color:#f92672>&lt;</span>ValueType<span style=color:#f92672>&gt;::</span>max();
    }

    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>Exp2</span>(<span style=color:#66d9ef>double</span> <span style=color:#f92672>&amp;</span>exp2, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>double</span> <span style=color:#f92672>&amp;</span>val);
};

<span style=color:#75715e>#endif
</span></code></pre></div><p>为了方便生成静态库文件，我们先将 calculator.cc 这个文件放到 archive 目录下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// archive/calculator.cc
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;../util/calculator.h&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> Calculator<span style=color:#f92672>::</span>Exp2(<span style=color:#66d9ef>double</span> <span style=color:#f92672>&amp;</span>exp2, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>double</span> <span style=color:#f92672>&amp;</span>val)
{
    <span style=color:#66d9ef>if</span> (std<span style=color:#f92672>::</span>sqrt(ValueTypeMax(val)) <span style=color:#f92672>&lt;</span> val)
    {
        exp2 <span style=color:#f92672>=</span> ValueTypeMax(val);
        <span style=color:#66d9ef>return</span> error_data_overflow;
    }
    exp2 <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>exp2(val);
    <span style=color:#66d9ef>return</span> exit_success;
}

</code></pre></div><p>对于 calculator.cc 这个源文件，我们可以使用 -c 参数将其编译为 obj 文件，再使用 ar 归档就能将其编译为一个 .a 库文件了：：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ g++ calculator.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -c
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ ar -crv libcalculator.a calculator.o
a - calculator.o
</code></pre></div><h3 id=32-使用-gcc-编译项目和链接静态库>3.2 使用 GCC 编译项目和链接静态库<a hidden class=anchor aria-hidden=true href=#32-使用-gcc-编译项目和链接静态库>#</a></h3>
<p>现在的目录结构如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ tree
.
|-- archive
|   |-- calculator.cc
|   |-- calculator.o
|   <span style=color:#e6db74>`</span>-- libcalculator.a
|-- CMakeLists.txt
|-- definition
|   <span style=color:#e6db74>`</span>-- error_code.h
|-- main.cc
<span style=color:#e6db74>`</span>-- util
    |-- calculator.h
    <span style=color:#e6db74>`</span>-- singleton.h

<span style=color:#ae81ff>3</span> directories, <span style=color:#ae81ff>8</span> files
</code></pre></div><p>使用 GCC 编译和链接到对应的静态库文件即可得到可执行文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ g++ main.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -o Exp2 -Larchive -lcalculator
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ll Exp2 
32K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen 31K Jun <span style=color:#ae81ff>21</span> 14:38 Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ./Exp2
<span style=color:#ae81ff>8</span>
<span style=color:#ae81ff>256</span>
</code></pre></div><p>需要注意的点有：</p>
<ol>
<li>-Llib 用于指定库文件目录</li>
<li>-lsingleton 用于指定库文件</li>
<li>-L 和 -l 参数一定要在 -o 参数之后</li>
</ol>
<h3 id=33-使用-cmake-构建项目和链接静态库>3.3 使用 cmake 构建项目和链接静态库<a hidden class=anchor aria-hidden=true href=#33-使用-cmake-构建项目和链接静态库>#</a></h3>
<p>我们刚才已经用 GCC 编译好了静态库文件，所以可以直接在 CMakeLists.txt 里添加链接静态库的指令：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#e6db74>Exp2</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style=color:#e6db74>bin/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;source dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;binary dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_BINARY_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;output dir: &#34;</span> <span style=color:#f92672>${</span>CMAKE_RUNTIME_OUTPUT_DIRECTORY<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>include_directories(<span style=color:#e6db74>./</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>aux_source_directory(<span style=color:#e6db74>./</span> <span style=color:#e6db74>SOURCE_DIR</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>link_directories(<span style=color:#e6db74>archive/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#e6db74>Exp2</span> <span style=color:#f92672>${</span>SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>target_link_libraries(<span style=color:#e6db74>Exp2</span> <span style=color:#e6db74>libcalculator.a</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># target_link_libraries(Exp2 calculator)
</span></code></pre></div><p>和之前相比，额外使用的指令有：</p>
<ol>
<li>link_directories：指定静态库或动态库的搜索路径</li>
<li>target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价</li>
</ol>
<p>然后进入 build 目录进行构建：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ rm -rf *
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- source dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target Exp2
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/Exp2.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable bin/Exp2
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ll bin/Exp2 
32K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen 31K Jun <span style=color:#ae81ff>21</span> 14:58 bin/Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./bin/Exp2 
<span style=color:#ae81ff>6</span>
<span style=color:#ae81ff>64</span>
</code></pre></div><p>可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接得到的二进制文件大小是相同的。这次用 <code>set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)</code> 命令将生成的二进制文件放到了 bin 目录下，注意这里的 bin 目录是使用 cmake 进行构建的目录（PROJECT_BINARY_DIR），不是 CMakeLists.txt 所在的目录（PROJECT_SOURCE_DIR）。</p>
<h3 id=34-使用-cmake-构建静态库文件和项目>3.4 使用 cmake 构建静态库文件和项目<a hidden class=anchor aria-hidden=true href=#34-使用-cmake-构建静态库文件和项目>#</a></h3>
<p>除了直接引用外部的静态库，cmake 还可以先将源文件编译成静态库之后在进行构建：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>project_name</span> <span style=color:#e6db74>Exp2</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style=color:#e6db74>bin/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;source dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;binary dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_BINARY_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;output dir: &#34;</span> <span style=color:#e6db74>&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>include_directories(<span style=color:#e6db74>./</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>aux_source_directory(<span style=color:#e6db74>./</span> <span style=color:#e6db74>SOURCE_DIR</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>static_lib_source_file</span> <span style=color:#e6db74>archive/calculator.cc</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_library(<span style=color:#e6db74>calculator_static</span> <span style=color:#e6db74>STATIC</span> <span style=color:#f92672>${</span>static_lib_source_file<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span> <span style=color:#f92672>${</span>SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>target_link_libraries(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span> <span style=color:#e6db74>calculator_static</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>这里用到了一个新的指令 <a href="https://cmake.org/cmake/help/latest/command/add_library.html?highlight=add_library">add_library</a> 来使用指定的源文件生成库文件，再使用 target_link_libraries 将生成的库文件添加到项目中；接下来进行构建：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ rm -rf *
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- source dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target calculator_static
<span style=color:#f92672>[</span> 25%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/calculator_static.dir/archive/calculator.cc.o
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Linking CXX static library libcalculator_static.a
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Built target calculator_static
Scanning dependencies of target Exp2
<span style=color:#f92672>[</span> 75%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/Exp2.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable bin/Exp2
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ll | grep calculator
 12K -rw-rw-r-- <span style=color:#ae81ff>1</span> joelzychen joelzychen  11K Jun <span style=color:#ae81ff>21</span> 15:30 libcalculator_static.a
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./bin/Exp2 
<span style=color:#ae81ff>5</span>
<span style=color:#ae81ff>32</span>
</code></pre></div><p>可以看到在 build 目录下生成了一个名为 libcalculator_static.a 的静态库文件，这个名字是由使用 add_library 指令时的第一个参数指定的。</p>
<h2 id=4-构建依赖于动态库的项目>4. 构建依赖于动态库的项目<a hidden class=anchor aria-hidden=true href=#4-构建依赖于动态库的项目>#</a></h2>
<h3 id=41-使用-gcc-编译动态库文件>4.1 使用 GCC 编译动态库文件<a hidden class=anchor aria-hidden=true href=#41-使用-gcc-编译动态库文件>#</a></h3>
<p>仍然使用之前已有的文件，在 archive 目录下生成动态库文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ rm calculator.o libcalculator.a
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ g++ calculator.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -c -fPIC
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ g++ calculator.o -g -Wall -std<span style=color:#f92672>=</span>c++11 -shared -o libcalculator.so
</code></pre></div><p>分为两个步骤：</p>
<ol>
<li>使用 -c 和 -fPIC 参数生成位置无关的（position independent code）机器码 .o 文件</li>
<li>使用 -shared 参数生成 .so 动态库文件</li>
</ol>
<p>也可以合并为一个步骤：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/archive<span style=color:#f92672>]</span>$ g++ calculator.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -shared -fPIC -o libcalculator.so
</code></pre></div><p>这样可以直接生成动态库文件，省去生成机器码文件的中间步骤。</p>
<h3 id=42-使用-gcc-编译项目和链接动态库>4.2 使用 GCC 编译项目和链接动态库<a hidden class=anchor aria-hidden=true href=#42-使用-gcc-编译项目和链接动态库>#</a></h3>
<p>和链接到静态库类似，在编译后链接动态库即可生成二进制文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ g++ main.cc -g -Wall -std<span style=color:#f92672>=</span>c++11 -o Exp2 -Larchive -lcalculator
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ./Exp2 
./Exp2: error <span style=color:#66d9ef>while</span> loading shared libraries: libcalculator.so: cannot open shared object file: No such file or directory
</code></pre></div><p>我们发现在运行二级制文件时会出现找不到动态库的报错，这是因为动态链接库环境变量的目录下没有找到编译时所用到的动态库，我们可以将对应的目录添加到环境变量下，或是将动态库拷贝到环境变量的目录下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ echo $LD_LIBRARY_PATH

<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ export LD_LIBRARY_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/usr/lib/&#34;</span>
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ sudo cp archive/libcalculator.so /usr/lib/
</code></pre></div><p>接下来就可以运行可执行文件了，可以看到使用链接动态库方式生成的可执行文件的大小要小于使用链接静态库方式生成的可执行文件，使用 ldd 命令也能看到可执行文件是正确地调用了对应的动态库文件：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ./Exp2 
<span style=color:#ae81ff>9</span>
<span style=color:#ae81ff>512</span>
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ll Exp2 
28K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen 28K Jun <span style=color:#ae81ff>21</span> 14:25 Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial<span style=color:#f92672>]</span>$ ldd Exp2 | grep calculator
        libcalculator.so <span style=color:#f92672>=</span>&gt; /usr/lib/libcalculator.so <span style=color:#f92672>(</span>0x00007fd2391f0000<span style=color:#f92672>)</span>
</code></pre></div><h3 id=43-使用-cmake-构建项目和链接动态库>4.3 使用 cmake 构建项目和链接动态库<a hidden class=anchor aria-hidden=true href=#43-使用-cmake-构建项目和链接动态库>#</a></h3>
<p>和构建静态库类似，只需要将 CMakeLists.txt 中链接静态库的指令修改为链接动态库即可进行构建：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#e6db74>Exp2</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style=color:#e6db74>bin/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;source dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;binary dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_BINARY_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;output dir: &#34;</span> <span style=color:#e6db74>&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>include_directories(<span style=color:#e6db74>./</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>aux_source_directory(<span style=color:#e6db74>./</span> <span style=color:#e6db74>SOURCE_DIR</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>link_directories(<span style=color:#e6db74>archive/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#e6db74>Exp2</span> <span style=color:#f92672>${</span>SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>target_link_libraries(<span style=color:#e6db74>Exp2</span> <span style=color:#e6db74>libcalculator.so</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ rm -rf *
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- source dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target Exp2
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/Exp2.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable bin/Exp2
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ll bin/Exp2 
28K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen 28K Jun <span style=color:#ae81ff>21</span> 15:04 bin/Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ldd bin/Exp2 | grep calculator
        libcalculator.so <span style=color:#f92672>=</span>&gt; /home/joelzychen/cmake-tutorial/archive/libcalculator.so <span style=color:#f92672>(</span>0x00007f4c87e35000<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./bin/Exp2 
<span style=color:#ae81ff>6</span>
<span style=color:#ae81ff>64</span>
</code></pre></div><p>可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接动态库得到的二进制文件大小也是相同的。</p>
<h3 id=44-使用-cmake-构建动态库文件和项目>4.4 使用 cmake 构建动态库文件和项目<a hidden class=anchor aria-hidden=true href=#44-使用-cmake-构建动态库文件和项目>#</a></h3>
<p>使用 cmake 构建动态库的步骤和构建静态库的步骤几乎一模一样，只需要将 add_library 的 STATIC 参数改为 SHARED 即可：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake>cmake_minimum_required(<span style=color:#e6db74>VERSION</span> <span style=color:#e6db74>3.10</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>project_name</span> <span style=color:#e6db74>Exp2</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>project(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_COMPILER</span> <span style=color:#e6db74>&#34;c++&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD</span> <span style=color:#e6db74>11</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_STANDARD_REQUIRED</span> <span style=color:#e6db74>True</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>-g</span> <span style=color:#e6db74>-Wall</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>string(<span style=color:#e6db74>REPLACE</span> <span style=color:#e6db74>&#34;;&#34;</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#e6db74>CMAKE_CXX_FLAGS</span> <span style=color:#e6db74>&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style=color:#e6db74>bin/</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;source dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;binary dir: &#34;</span> <span style=color:#f92672>${</span>PROJECT_BINARY_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>message(<span style=color:#e6db74>STATUS</span> <span style=color:#e6db74>&#34;output dir: &#34;</span> <span style=color:#e6db74>&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>include_directories(<span style=color:#e6db74>./</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>aux_source_directory(<span style=color:#e6db74>./</span> <span style=color:#e6db74>SOURCE_DIR</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>set(<span style=color:#e6db74>shared_lib_source_file</span> <span style=color:#e6db74>archive/calculator.cc</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_library(<span style=color:#e6db74>calculator_shared</span> <span style=color:#e6db74>SHARED</span> <span style=color:#f92672>${</span>shared_lib_source_file<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>add_executable(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span> <span style=color:#f92672>${</span>SOURCE_DIR<span style=color:#f92672>}</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>target_link_libraries(<span style=color:#f92672>${</span>project_name<span style=color:#f92672>}</span> <span style=color:#e6db74>calculator_shared</span>)<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ rm -rf *
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc
-- Check <span style=color:#66d9ef>for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style=color:#66d9ef>done</span>
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++
-- Check <span style=color:#66d9ef>for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style=color:#66d9ef>done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style=color:#66d9ef>done</span>
-- source dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style=color:#66d9ef>done</span>
-- Generating <span style=color:#66d9ef>done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ make
Scanning dependencies of target calculator_shared
<span style=color:#f92672>[</span> 25%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/calculator_shared.dir/archive/calculator.cc.o
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Linking CXX shared library libcalculator_shared.so
<span style=color:#f92672>[</span> 50%<span style=color:#f92672>]</span> Built target calculator_shared
Scanning dependencies of target Exp2
<span style=color:#f92672>[</span> 75%<span style=color:#f92672>]</span> Building CXX object CMakeFiles/Exp2.dir/main.cc.o
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Linking CXX executable bin/Exp2
<span style=color:#f92672>[</span>100%<span style=color:#f92672>]</span> Built target Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ll | grep calculator
 16K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen  13K Jun <span style=color:#ae81ff>21</span> 15:34 libcalculator_shared.so
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ll bin/Exp2 
28K -rwxrwxr-x <span style=color:#ae81ff>1</span> joelzychen joelzychen 28K Jun <span style=color:#ae81ff>21</span> 15:34 bin/Exp2
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ldd bin/Exp2 | grep calculator
        libcalculator_shared.so <span style=color:#f92672>=</span>&gt; /home/joelzychen/cmake-tutorial/build/libcalculator_shared.so <span style=color:#f92672>(</span>0x00007f1fa5aa5000<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>joelzychen@DevCloud ~/cmake-tutorial/build<span style=color:#f92672>]</span>$ ./bin/Exp2 
<span style=color:#ae81ff>7</span>
<span style=color:#ae81ff>128</span>
</code></pre></div><p>可以看到得到的二进制文件的相关信息和使用前几种方法得到的都是相同的。</p>
<h2 id=5-常用命令>5. 常用命令<a hidden class=anchor aria-hidden=true href=#5-常用命令>#</a></h2>
<h3 id=51-项目相关>5.1 项目相关<a hidden class=anchor aria-hidden=true href=#51-项目相关>#</a></h3>
<ul>
<li>cmake_minimum_required(VERSION 3.10)：指定 cmake 的最低版本要求</li>
<li>project(project_name)：指定项目的名称</li>
<li>set(CMAKE_CXX_FLAGS -g -Wall -pthread)：设置普通变量，缓存变量或环境变量</li>
</ul>
<h3 id=52-编译相关>5.2 编译相关<a hidden class=anchor aria-hidden=true href=#52-编译相关>#</a></h3>
<ul>
<li>include_directories：指定头文件的目录，类似于 GCC 编译时的 <code>-I</code> 参数；等价于将头文件目录添加到环境变量 CPLUS_INCLUDE_PATH 中</li>
<li>aux_source_directory：在目录中（不含子目录）查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中</li>
<li>add_executable：使用列出的源文件构建可执行文件</li>
<li>add_definitions：宏定义</li>
</ul>
<h3 id=53-链接相关>5.3 链接相关<a hidden class=anchor aria-hidden=true href=#53-链接相关>#</a></h3>
<ul>
<li>link_directories：指定库文件的目录，类似于 GCC 链接时的 <code>-L</code> 参数；等价于将库文件目录添加到环境变量 LD_LIBRARY_PATH 中</li>
<li>target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价</li>
</ul>
<h2 id=6-总结>6. 总结<a hidden class=anchor aria-hidden=true href=#6-总结>#</a></h2>
<p>本文通过几个示例程序对比了在 Linux 下使用 GCC 和 cmake 来编译和构建程序的基本步骤，了解了一些 cmake 的基础指令。实际开发中的项目往往会非常大，以致于不能够直接使用 GCC 来编译整个项目，在这种场景下使用 cmake 进行构建往往能够节省时间和提高效率，让我们能够专注在项目的开发上。在实际应用中编写 CMakeLists.txt 的时候还会遇到非常多的问题、不熟悉的指令和其他的使用技巧，这些都需要结合<a href=https://cmake.org/cmake/help/latest/index.html>教程</a>和实践来进一步学习。</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=http://zintrulcre.github.io/posts/c++/boost/boost-typeindex/>
<span class=title>« Prev Page</span>
<br>
<span>boost::typeIndex 的相关探究</span>
</a>
<a class=next href=http://zintrulcre.github.io/posts/c++/compilation/gdb/>
<span class=title>Next Page »</span>
<br>
<span>GDB 调试入门</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>
Zhengyu &copy; 2022
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>